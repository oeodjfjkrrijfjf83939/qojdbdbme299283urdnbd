<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit User - MultiLynk QR Manager</title>
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="config.js"></script>
</head>

<body>
  <div class="container">
    <div class="page-header">
      <h1 id="formTitle">âœï¸ Add New User</h1>
      <p class="subtitle">Fill in the platforms you use - leave others blank</p>
      <div id="adminLinks" class="admin-links hidden">
        <a href="index.html" class="btn-secondary">
          <span>ğŸ </span> Back to Dashboard
        </a>
      </div>
    </div>

    <form id="userForm">
      <!-- Basic Info -->
      <div class="form-section basic-info">
        <h3>ğŸ“ Basic Information <span class="platform-count">Required</span></h3>
        <input type="text" id="username" placeholder="Username (e.g., john-doe)" required>
        <small class="form-hint">ğŸ’¡ Multiple users can have the same username - User Code makes each one unique</small>
        <input type="text" id="fullname" placeholder="Full Name" required>

        <label for="publicDescription"
          style="display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 500;">ğŸ“„
          About / Description (Public)</label>
        <textarea id="publicDescription"
          placeholder="Add a brief description about yourself or your organization (e.g., 'Slogans', 'Professional photographer specializing in weddings', 'Best Italian restaurant in downtown'). This will be shown on your public profile."
          rows="3"></textarea>
        <small class="form-hint">ğŸ’¡ This description will appear on your profile page. Leave blank to show your username
          instead.</small>

        <input type="text" id="userCode" placeholder="User Code (auto-generated)" readonly class="readonly-input">
        <small class="form-note">ğŸ”’ User Code is auto-generated and ensures uniqueness - This is what makes each user
          unique!</small>

        <label for="description" style="display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 500;">ğŸ“
          Internal Description (Admin Only)</label>
        <textarea id="description"
          placeholder="Add notes about this client (e.g., Business type, payment/plan type, contact details source, special requirements, personal secret id for future payment distributions). This will NOT be shown on their public profile."
          rows="3"></textarea>
      </div>

      <!-- Professional & Business Networks -->
      <div class="form-section" class="form-section professional">
        <h3>ğŸ’¼ Professional & Business Networks <span class="platform-count">5</span></h3>
        <small>Professional networking and career platforms</small>
        <input type="url" id="linkedin" placeholder="LinkedIn - https://linkedin.com/in/username">
        <input type="url" id="xing" placeholder="Xing - https://xing.com/profile/username">
        <input type="url" id="angellist" placeholder="AngelList - https://angel.co/username">
        <input type="url" id="meetup" placeholder="Meetup - https://meetup.com/members/username">
        <input type="url" id="opportunity" placeholder="Opportunity - https://opportunity.com/username">

        <div id="professional-custom-container" class="custom-links-container"></div>
        <button type="button" class="add-certificate-btn" onclick="addCustomLink('professional', 'ğŸ’¼ Professional')">
          â• Add Custom Link
        </button>
      </div>

      <!-- Creative & Design Portfolios -->
      <div class="form-section" class="form-section design">
        <h3>ğŸ¨ Creative & Design Portfolios <span class="platform-count">6</span></h3>
        <small>Showcase your creative work</small>
        <input type="url" id="behance" placeholder="Behance - https://behance.net/username">
        <input type="url" id="dribbble" placeholder="Dribbble - https://dribbble.com/username">
        <input type="url" id="figma" placeholder="Figma - https://figma.com/@username">
        <input type="url" id="portfolio" placeholder="Portfolio - Your personal portfolio URL">
        <input type="url" id="artstation" placeholder="ArtStation - https://artstation.com/username">
        <input type="url" id="zerply" placeholder="Zerply - https://zerply.com/username">

        <div id="design-custom-container" class="custom-links-container"></div>
        <button type="button" class="add-certificate-btn" onclick="addCustomLink('design', 'ğŸ¨ Design')">
          â• Add Custom Link
        </button>
      </div>

      <!-- Social Media -->
      <div class="form-section" class="form-section social">
        <h3>ğŸ“± Social Media Platforms <span class="platform-count">6</span></h3>
        <small>Popular social networking sites</small>
        <input type="url" id="instagram" placeholder="Instagram - https://instagram.com/username">
        <input type="url" id="twitter" placeholder="Twitter/X - https://twitter.com/username">
        <input type="url" id="facebook" placeholder="Facebook - https://facebook.com/username">
        <input type="url" id="threads" placeholder="Threads - https://threads.net/@username">
        <input type="url" id="mastodon" placeholder="Mastodon - https://mastodon.social/@username">
        <input type="url" id="bluesky" placeholder="BlueSky - https://bsky.app/profile/username">

        <div id="social-custom-container" class="custom-links-container"></div>
        <button type="button" class="add-certificate-btn" onclick="addCustomLink('social', 'ğŸ“± Social')">
          â• Add Custom Link
        </button>
      </div>

      <!-- Video Platforms -->
      <div class="form-section" class="form-section video">
        <h3>ğŸ¥ Video Platforms <span class="platform-count">6</span></h3>
        <small>Video sharing and live streaming</small>
        <input type="url" id="youtube" placeholder="YouTube - https://youtube.com/@username">
        <input type="url" id="tiktok" placeholder="TikTok - https://tiktok.com/@username">
        <input type="url" id="vimeo" placeholder="Vimeo - https://vimeo.com/username">
        <input type="url" id="twitch" placeholder="Twitch - https://twitch.tv/username">
        <input type="url" id="rumble" placeholder="Rumble - https://rumble.com/c/username">
        <input type="url" id="dailymotion" placeholder="Dailymotion - https://dailymotion.com/username">

        <div id="video-custom-container" class="custom-links-container"></div>
        <button type="button" class="add-certificate-btn" onclick="addCustomLink('video', 'ğŸ¥ Video')">
          â• Add Custom Link
        </button>
      </div>

      <!-- Music & Audio -->
      <div class="form-section" class="form-section music">
        <h3>ğŸµ Music & Audio Platforms <span class="platform-count">4</span></h3>
        <small>Music streaming and audio content</small>
        <input type="url" id="spotify" placeholder="Spotify - Artist or Playlist URL">
        <input type="url" id="soundcloud" placeholder="SoundCloud - https://soundcloud.com/username">
        <input type="url" id="applemusic" placeholder="Apple Music - Artist URL">
        <input type="url" id="bandcamp" placeholder="Bandcamp - https://username.bandcamp.com">

        <div id="music-custom-container" class="custom-links-container"></div>
        <button type="button" class="add-certificate-btn" onclick="addCustomLink('music', 'ğŸµ Music')">
          â• Add Custom Link
        </button>
      </div>

      <!-- Developer Platforms -->
      <div class="form-section" class="form-section developer">
        <h3>ğŸ’» Developer & Tech Communities <span class="platform-count">6</span></h3>
        <small>Code repositories and developer communities</small>
        <input type="url" id="github" placeholder="GitHub - https://github.com/username">
        <input type="url" id="gitlab" placeholder="GitLab - https://gitlab.com/username">
        <input type="url" id="bitbucket" placeholder="Bitbucket - https://bitbucket.org/username">
        <input type="url" id="stackoverflow" placeholder="Stack Overflow - Profile URL">
        <input type="url" id="devto" placeholder="Dev.to - https://dev.to/username">
        <input type="url" id="codepen" placeholder="CodePen - https://codepen.io/username">

        <div id="developer-custom-container" class="custom-links-container"></div>
        <button type="button" class="add-certificate-btn" onclick="addCustomLink('developer', 'ğŸ’» Developer')">
          â• Add Custom Link
        </button>
      </div>

      <!-- Messaging & Communication -->
      <div class="form-section" class="form-section messaging">
        <h3>ğŸ’¬ Messaging & Communication <span class="platform-count">10</span></h3>
        <small>Instant messaging and communication apps</small>
        <div class="upi-input-group">
          <input type="text" id="whatsapp"
            placeholder="WhatsApp - https://wa.me/phonenumber, https://wa.me/phonenumber2">
          <button type="button" class="add-upi-btn" data-target="whatsapp"
            title="Add another WhatsApp number">+</button>
        </div>
        <input type="url" id="telegram" placeholder="Telegram - https://t.me/username">
        <input type="url" id="discord" placeholder="Discord - https://discord.gg/serverinvite or username#0000">
        <input type="url" id="signal" placeholder="Signal - Signal username or phone">
        <input type="url" id="skype" placeholder="Skype - Skype username or link">
        <input type="url" id="slack" placeholder="Slack - Workspace or Profile URL">
        <input type="url" id="wechat" placeholder="WeChat - WeChat ID">
        <input type="url" id="line" placeholder="LINE - LINE ID or https://line.me/ti/p/username">
        <input type="url" id="viber" placeholder="Viber - Viber username or link">
        <input type="url" id="messenger" placeholder="Messenger - https://m.me/username">

        <div id="messaging-custom-container" class="custom-links-container"></div>
        <button type="button" class="add-certificate-btn" onclick="addCustomLink('messaging', 'ğŸ’¬ Messaging')">
          â• Add Custom Link
        </button>
      </div>

      <!-- Gaming Platforms -->
      <div class="form-section" class="form-section gaming">
        <h3>ğŸ® Gaming Platforms <span class="platform-count">7</span></h3>
        <small>Gaming networks and profiles</small>
        <input type="url" id="steam" placeholder="Steam - https://steamcommunity.com/id/username">
        <input type="url" id="xbox" placeholder="Xbox - Gamertag or Profile URL">
        <input type="url" id="playstation" placeholder="PlayStation - PSN ID or Profile URL">
        <input type="url" id="nintendo" placeholder="Nintendo - Friend Code or Profile">
        <input type="url" id="dream11" placeholder="Dream11 - https://dream11.com/profile/username">
        <input type="url" id="mpl" placeholder="MPL - https://mpl.live/profile/username">
        <input type="url" id="winzo" placeholder="WinZO - https://winzo.com/profile/username">

        <div id="gaming-custom-container" class="custom-links-container"></div>
        <button type="button" class="add-certificate-btn" onclick="addCustomLink('gaming', 'ğŸ® Gaming')">
          â• Add Custom Link
        </button>
      </div>

      <!-- Creator & Monetization -->
      <div class="form-section" class="form-section creator">
        <h3>ğŸ’° Creator & Monetization <span class="platform-count">4</span></h3>
        <small>Support and subscription platforms</small>
        <input type="url" id="patreon" placeholder="Patreon - https://patreon.com/username">
        <input type="url" id="kofi" placeholder="Ko-fi - https://ko-fi.com/username">
        <input type="url" id="buymeacoffee" placeholder="Buy Me a Coffee - https://buymeacoffee.com/username">
        <input type="url" id="substack" placeholder="Substack - https://username.substack.com">

        <div id="creator-custom-container" class="custom-links-container"></div>
        <button type="button" class="add-certificate-btn" onclick="addCustomLink('creator', 'ğŸ’° Creator')">
          â• Add Custom Link
        </button>
      </div>

      <!-- E-commerce & Shopping -->
      <div class="form-section" class="form-section ecommerce">
        <h3>ğŸ›’ E-Commerce & Shopping <span class="platform-count">10</span></h3>
        <small>Online stores and marketplaces</small>
        <input type="url" id="etsy" placeholder="Etsy - https://etsy.com/shop/shopname">
        <input type="url" id="amazon" placeholder="Amazon - Store or Author Page URL">
        <input type="url" id="shopify" placeholder="Shopify - https://yourstore.myshopify.com">
        <input type="url" id="flipkart" placeholder="Flipkart - https://flipkart.com/shop/shopname">
        <input type="url" id="myntra" placeholder="Myntra - https://myntra.com/shop/shopname">
        <input type="url" id="meesho" placeholder="Meesho - https://meesho.com/shop/shopname">
        <input type="url" id="nykaa" placeholder="Nykaa - https://nykaa.com/shop/shopname">
        <input type="url" id="bigbasket" placeholder="BigBasket - https://bigbasket.com/shop/shopname">
        <input type="url" id="blinkit" placeholder="Blinkit - https://blinkit.com/shop/shopname">
        <input type="url" id="zepto" placeholder="Zepto - https://zepto.com/shop/shopname">

        <div id="ecommerce-custom-container" class="custom-links-container"></div>
        <button type="button" class="add-certificate-btn" onclick="addCustomLink('ecommerce', 'ğŸ› E-commerce')">
          â• Add Custom Link
        </button>
      </div>

      <!-- Photography & Visual Arts -->
      <div class="form-section" class="form-section photography">
        <h3>ğŸ“· Photography & Visual Arts <span class="platform-count">3</span></h3>
        <small>Photo sharing and portfolio sites</small>
        <input type="url" id="flickr" placeholder="Flickr - https://flickr.com/photos/username">
        <input type="url" id="500px" placeholder="500px - https://500px.com/p/username">
        <input type="url" id="unsplash" placeholder="Unsplash - https://unsplash.com/@username">

        <div id="photography-custom-container" class="custom-links-container"></div>
        <button type="button" class="add-certificate-btn" onclick="addCustomLink('photography', 'ğŸ“· Photography')">
          â• Add Custom Link
        </button>
      </div>

      <!-- Blogging & Writing -->
      <div class="form-section" class="form-section blogging">
        <h3>âœï¸ Blogging & Writing <span class="platform-count">3</span></h3>
        <small>Blog and writing platforms</small>
        <input type="url" id="medium" placeholder="Medium - https://medium.com/@username">
        <input type="url" id="wordpress" placeholder="WordPress - https://username.wordpress.com">
        <input type="url" id="blogger" placeholder="Blogger - https://username.blogspot.com">

        <div id="blogging-custom-container" class="custom-links-container"></div>
        <button type="button" class="add-certificate-btn" onclick="addCustomLink('blogging', 'âœï¸ Blogging')">
          â• Add Custom Link
        </button>
      </div>

      <!-- Other Social Platforms -->
      <div class="form-section" class="form-section misc-social">
        <h3>ğŸŒ Other Social Platforms <span class="platform-count">17</span></h3>
        <small>Additional social networks and trending platforms</small>
        <input type="url" id="pinterest" placeholder="Pinterest - https://pinterest.com/username">
        <input type="url" id="reddit" placeholder="Reddit - https://reddit.com/user/username">
        <input type="url" id="snapchat" placeholder="Snapchat - https://snapchat.com/add/username">
        <input type="url" id="tumblr" placeholder="Tumblr - https://username.tumblr.com">
        <input type="url" id="bereal" placeholder="BeReal - https://bere.al/username">
        <input type="url" id="clubhouse" placeholder="Clubhouse - https://clubhouse.com/@username">
        <input type="url" id="nextdoor" placeholder="Nextdoor - https://nextdoor.com/p/username">
        <input type="url" id="strava" placeholder="Strava - https://strava.com/athletes/username">
        <input type="url" id="sharechat" placeholder="ShareChat - https://sharechat.com/profile/username">
        <input type="url" id="moj" placeholder="Moj - https://moj.com/@username">
        <input type="url" id="josh" placeholder="Josh - https://josh.com/@username">
        <input type="url" id="koo" placeholder="Koo - https://kooapp.com/profile/username">
        <input type="url" id="mxtakatak" placeholder="MX TakaTak - https://mxtakatak.com/@username">
        <input type="url" id="vk" placeholder="VK - https://vk.com/username">
        <input type="url" id="ok" placeholder="OK.ru - https://ok.ru/username">
        <input type="url" id="kakaotalk" placeholder="Kakao Talk - Kakao ID">
        <input type="url" id="quora" placeholder="Quora - https://quora.com/profile/username">

        <div id="miscSocial-custom-container" class="custom-links-container"></div>
        <button type="button" class="add-certificate-btn" onclick="addCustomLink('miscSocial', 'ğŸŒ Other Social')">
          â• Add Custom Link
        </button>
      </div>

      <!-- Productivity & Tools -->
      <div class="form-section" class="form-section productivity">
        <h3>ğŸ”§ Productivity & Tools <span class="platform-count">3</span></h3>
        <small>Useful tools and link aggregators</small>
        <input type="url" id="linktree" placeholder="Linktree - https://linktr.ee/username">
        <input type="url" id="notion" placeholder="Notion - Public Page URL">
        <input type="url" id="calendly" placeholder="Calendly - https://calendly.com/username">

        <div id="productivity-custom-container" class="custom-links-container"></div>
        <button type="button" class="add-certificate-btn" onclick="addCustomLink('productivity', 'ğŸ”§ Productivity')">
          â• Add Custom Link
        </button>
      </div>

      <!-- Payment & Donation Platforms -->
      <div class="form-section payment">
        <h3>ğŸ’³ Payment & Donation Platforms <span class="platform-count">15</span></h3>
        <small>Payment links and UPI IDs. For multiple UPI IDs, separate with commas (e.g., id1@bank, id2@bank)</small>

        <input type="url" id="paypal" placeholder="PayPal - https://paypal.me/username">
        <input type="url" id="cashapp" placeholder="Cash App - https://cash.app/$username">
        <input type="url" id="razorpay" placeholder="Razorpay - https://razorpay.me/@username">

        <div class="upi-input-group">
          <input type="text" id="gpay" placeholder="Google Pay UPI ID(s) - username@okaxis">
          <button type="button" class="add-upi-btn" data-target="gpay" title="Add another UPI ID">+</button>
        </div>

        <div class="upi-input-group">
          <input type="text" id="phonepe" placeholder="PhonePe UPI ID(s) - username@ybl">
          <button type="button" class="add-upi-btn" data-target="phonepe" title="Add another UPI ID">+</button>
        </div>

        <div class="upi-input-group">
          <input type="text" id="paytm" placeholder="PayTM UPI ID(s) - username@paytm">
          <button type="button" class="add-upi-btn" data-target="paytm" title="Add another UPI ID">+</button>
        </div>

        <div class="upi-input-group">
          <input type="text" id="upi" placeholder="UPI ID(s) - username@upi">
          <button type="button" class="add-upi-btn" data-target="upi" title="Add another UPI ID">+</button>
        </div>

        <div class="upi-input-group">
          <input type="text" id="cred" placeholder="CRED UPI ID(s) - username@cred">
          <button type="button" class="add-upi-btn" data-target="cred" title="Add another UPI ID">+</button>
        </div>

        <div class="upi-input-group">
          <input type="text" id="mobikwik" placeholder="MobiKwik UPI ID(s) - username@ikwik">
          <button type="button" class="add-upi-btn" data-target="mobikwik" title="Add another UPI ID">+</button>
        </div>

        <div class="upi-input-group">
          <input type="text" id="freecharge" placeholder="Freecharge UPI ID(s) - username@freecharge">
          <button type="button" class="add-upi-btn" data-target="freecharge" title="Add another UPI ID">+</button>
        </div>

        <div class="upi-input-group">
          <input type="text" id="bhim" placeholder="BHIM UPI ID(s) - username@upi">
          <button type="button" class="add-upi-btn" data-target="bhim" title="Add another UPI ID">+</button>
        </div>

        <div class="upi-input-group">
          <input type="text" id="amazonpay" placeholder="Amazon Pay UPI ID(s) - username@amazon">
          <button type="button" class="add-upi-btn" data-target="amazonpay" title="Add another UPI ID">+</button>
        </div>

        <div class="upi-input-group">
          <input type="text" id="navi" placeholder="Navi UPI ID(s) - username@navi">
          <button type="button" class="add-upi-btn" data-target="navi" title="Add another UPI ID">+</button>
        </div>

        <div class="upi-input-group">
          <input type="text" id="jupiter" placeholder="Jupiter UPI ID(s) - username@jupiter">
          <button type="button" class="add-upi-btn" data-target="jupiter" title="Add another UPI ID">+</button>
        </div>

        <div class="upi-input-group">
          <input type="text" id="jiofinance" placeholder="JioFinance UPI ID(s) - username@jio">
          <button type="button" class="add-upi-btn" data-target="jiofinance" title="Add another UPI ID">+</button>
        </div>

        <div id="payment-custom-container" class="custom-links-container"></div>
        <button type="button" class="add-certificate-btn" onclick="addCustomLink('payment', 'ğŸ’³ Payment')">
          â• Add Custom Link
        </button>
      </div>

      <!-- Business & Professional Tools -->
      <div class="form-section business">
        <h3>ğŸ¢ Business & Professional Tools <span class="platform-count">4</span></h3>
        <small>Business analytics and professional resources</small>
        <input type="url" id="crunchbase" placeholder="Crunchbase - https://crunchbase.com/person/username">
        <input type="url" id="glassdoor" placeholder="Glassdoor - https://glassdoor.com/profile/username">
        <input type="url" id="indeed" placeholder="Indeed - https://indeed.com/profile/username">
        <input type="url" id="naukri" placeholder="Naukri - https://naukri.com/profile/username">

        <div id="business-custom-container" class="custom-links-container"></div>
        <button type="button" class="add-certificate-btn" onclick="addCustomLink('business', 'ğŸ¢ Business')">
          â• Add Custom Link
        </button>
      </div>

      <!-- Education & Learning -->
      <div class="form-section education">
        <h3>ğŸ“ Education & Learning <span class="platform-count">9</span></h3>
        <small>Educational and learning platforms</small>
        <input type="url" id="coursera" placeholder="Coursera - https://coursera.org/user/username">
        <input type="url" id="udemy" placeholder="Udemy - https://udemy.com/user/username">
        <input type="url" id="skillshare" placeholder="Skillshare - https://skillshare.com/user/username">
        <input type="url" id="khanacademy" placeholder="Khan Academy - https://khanacademy.org/profile/username">
        <input type="url" id="byjus" placeholder="BYJU'S - https://byjus.com/profile/username">
        <input type="url" id="unacademy" placeholder="Unacademy - https://unacademy.com/@username">
        <input type="url" id="vedantu" placeholder="Vedantu - https://vedantu.com/profile/username">
        <input type="url" id="upgrad" placeholder="upGrad - https://upgrad.com/profile/username">
        <input type="url" id="physicswallah" placeholder="PhysicsWallah - https://pw.live/@username">

        <div id="education-custom-container" class="custom-links-container"></div>
        <button type="button" class="add-certificate-btn" onclick="addCustomLink('education', 'ğŸ“ Education')">
          â• Add Custom Link
        </button>
      </div>


      <!-- Business Services & Pricing -->
      <div class="form-section pricing">
        <h3>ğŸ’¼ Business Services & Pricing <span class="platform-count">1</span></h3>
        <small>Share your price lists, service menus, rate cards, and pricing charts (for any business type)</small>
        <input type="url" id="pricelist" placeholder="Price List / Service Menu - https://yourpricing.com">

        <div id="pricing-custom-container" class="custom-links-container"></div>
        <button type="button" class="add-certificate-btn" onclick="addCustomLink('pricing', 'ğŸ’¼ Pricing')">
          â• Add Custom Link
        </button>
      </div>

      <!-- App Downloads -->
      <div class="form-section app-downloads">
        <h3>ğŸ“± App Downloads <span class="platform-count">2</span></h3>
        <small>Links to download your mobile application</small>
        <input type="url" id="playstore"
          placeholder="Play Store - https://play.google.com/store/apps/details?id=com.example.app">
        <input type="url" id="appstore" placeholder="App Store - https://apps.apple.com/app/id123456789">

        <div id="appDownloads-custom-container" class="custom-links-container"></div>
        <button type="button" class="add-certificate-btn" onclick="addCustomLink('appDownloads', 'ğŸ“± App Downloads')">
          â• Add Custom Link
        </button>
      </div>

      <!-- Booking & Actions -->
      <div class="form-section booking">
        <h3>ğŸ“… Booking & Actions <span class="platform-count">6</span></h3>
        <small>Direct links for bookings, appointments, tickets, reservations, and registrations (universal for any
          business)</small>
        <input type="url" id="bookingpage" placeholder="Booking Page - https://yourbooking.com">
        <input type="url" id="appointment"
          placeholder="Appointment - https://example.com/appointment or scheduling link">
        <input type="url" id="buytickets" placeholder="Buy Tickets - https://yourtickets.com or event ticket link">
        <input type="url" id="reservation"
          placeholder="Reservation - https://yourreservation.com (tables, hotels, etc.)">
        <input type="url" id="registration"
          placeholder="Registration - https://yourregistration.com (events, courses, etc.)">
        <input type="url" id="consultation"
          placeholder="Consultation - https://yourconsultation.com (book a call/meeting)">

        <div id="booking-custom-container" class="custom-links-container"></div>
        <button type="button" class="add-certificate-btn" onclick="addCustomLink('booking', 'ğŸ“… Booking')">
          â• Add Custom Link
        </button>
      </div>

      <!-- Forms -->
      <div class="form-section googleforms">
        <h3>ğŸ“‹ Forms <span class="platform-count" id="googleforms-count">0</span></h3>
        <small>Add your Google Forms, surveys, and questionnaires with custom titles</small>

        <div id="googleforms-container">
          <!-- Google Form entries will be added here dynamically -->
        </div>

        <button type="button" class="add-certificate-btn" onclick="addGoogleFormEntry()">
          â• Add Form
        </button>
      </div>

      <!-- Food & Dining -->
      <div class="form-section food">
        <h3>ğŸ” Food & Dining <span class="platform-count">9</span></h3>
        <small>Food delivery, restaurant platforms, and grocery delivery</small>
        <input type="url" id="swiggy" placeholder="Swiggy - https://swiggy.com/restaurants/username">
        <input type="url" id="zomato" placeholder="Zomato - https://zomato.com/username">
        <input type="url" id="dineout" placeholder="Dineout - https://dineout.co.in/restaurant/username">
        <input type="url" id="eatsure" placeholder="EatSure - https://eatsure.com/restaurant/username">
        <input type="url" id="magicpin" placeholder="Magicpin - https://magicpin.in/username">
        <input type="url" id="jiomart" placeholder="JioMart - https://jiomart.com/shop/username">
        <input type="url" id="swiggyinstamart" placeholder="Swiggy Instamart - https://swiggy.com/instamart/username">
        <input type="url" id="dunzo" placeholder="Dunzo - https://dunzo.com/shop/username">
        <input type="url" id="menucard" placeholder="Menu Card - https://yourdigitalmenu.com">

        <div id="food-custom-container" class="custom-links-container"></div>
        <button type="button" class="add-certificate-btn" onclick="addCustomLink('food', 'ğŸ” Food')">
          â• Add Custom Link
        </button>
      </div>

      <!-- Ride & Transportation -->
      <div class="form-section transportation">
        <h3>ğŸš— Ride & Transportation <span class="platform-count">4</span></h3>
        <small>Ride-hailing and transportation services</small>
        <input type="url" id="ola" placeholder="Ola - https://ola.com/profile/username">
        <input type="url" id="uber" placeholder="Uber - https://uber.com/profile/username">
        <input type="url" id="rapido" placeholder="Rapido - https://rapido.bike/profile/username">
        <input type="url" id="porter" placeholder="Porter - https://porter.in/profile/username">

        <div id="transportation-custom-container" class="custom-links-container"></div>
        <button type="button" class="add-certificate-btn"
          onclick="addCustomLink('transportation', 'ğŸš— Transportation')">
          â• Add Custom Link
        </button>
      </div>

      <!-- Travel & Hospitality -->
      <div class="form-section travel">
        <h3>âœˆï¸ Travel & Hospitality <span class="platform-count">5</span></h3>
        <small>Travel booking and hotel platforms</small>
        <input type="url" id="makemytrip" placeholder="MakeMyTrip - https://makemytrip.com/profile/username">
        <input type="url" id="goibibo" placeholder="Goibibo - https://goibibo.com/profile/username">
        <input type="url" id="oyo" placeholder="OYO - https://oyorooms.com/profile/username">
        <input type="url" id="cleartrip" placeholder="Cleartrip - https://cleartrip.com/profile/username">
        <input type="url" id="ixigo" placeholder="Ixigo - https://ixigo.com/profile/username">

        <div id="travel-custom-container" class="custom-links-container"></div>
        <button type="button" class="add-certificate-btn" onclick="addCustomLink('travel', 'âœˆï¸ Travel')">
          â• Add Custom Link
        </button>
      </div>

      <!-- Health & Wellness -->
      <div class="form-section health">
        <h3>ğŸ¥ Health & Wellness <span class="platform-count">4</span></h3>
        <small>Healthcare and wellness platforms</small>
        <input type="url" id="practo" placeholder="Practo - https://practo.com/doctor/username">
        <input type="url" id="onemg" placeholder="1mg - https://1mg.com/doctor/username">
        <input type="url" id="pharmeasy" placeholder="PharmEasy - https://pharmeasy.in/doctor/username">
        <input type="url" id="cultfit" placeholder="Cult.fit - https://cult.fit/profile/username">

        <div id="health-custom-container" class="custom-links-container"></div>
        <button type="button" class="add-certificate-btn" onclick="addCustomLink('health', 'ğŸ¥ Health')">
          â• Add Custom Link
        </button>
      </div>

      <!-- Entertainment & OTT -->
      <div class="form-section ott">
        <h3>ğŸ¬ Entertainment & OTT <span class="platform-count">8</span></h3>
        <small>Streaming platforms and entertainment services</small>
        <input type="url" id="jiocinema" placeholder="JioCinema - https://jiocinema.com/profile/username">
        <input type="url" id="hotstar" placeholder="Hotstar - https://hotstar.com/profile/username">
        <input type="url" id="netflix" placeholder="Netflix - https://netflix.com/profile/username">
        <input type="url" id="primevideo" placeholder="Prime Video - https://primevideo.com/profile/username">
        <input type="url" id="sonyliv" placeholder="Sony LIV - https://sonyliv.com/profile/username">
        <input type="url" id="zee5" placeholder="ZEE5 - https://zee5.com/profile/username">
        <input type="url" id="mxplayer" placeholder="MX Player - https://mxplayer.in/profile/username">
        <input type="url" id="imdb" placeholder="IMDb - https://imdb.com/name/username">

        <div id="ott-custom-container" class="custom-links-container"></div>
        <button type="button" class="add-certificate-btn" onclick="addCustomLink('ott', 'ğŸ¬ OTT')">
          â• Add Custom Link
        </button>
      </div>

      <!-- Books & Reading -->
      <div class="form-section books">
        <h3>ğŸ“š Books & Reading <span class="platform-count">1</span></h3>
        <small>Book lovers and reading communities</small>
        <input type="url" id="goodreads" placeholder="Goodreads - https://goodreads.com/user/show/username">

        <div id="books-custom-container" class="custom-links-container"></div>
        <button type="button" class="add-certificate-btn" onclick="addCustomLink('books', 'ğŸ“š Books')">
          â• Add Custom Link
        </button>
      </div>

      <!-- Certificates & Credentials -->
      <div class="form-section certificates">
        <h3>ğŸ“ Certificates & Credentials <span class="platform-count" id="cert-count">0</span></h3>
        <small>Add your certificates, credentials, and achievements with custom titles</small>

        <div id="certificates-container">
          <!-- Certificate entries will be added here dynamically -->
        </div>

        <button type="button" class="add-certificate-btn" onclick="addCertificateEntry()">
          â• Add Certificate
        </button>
      </div>

      <!-- Details & Licenses (Custom Key-Value Pairs) -->
      <div class="form-section details">
        <h3>ğŸªª Details & Licenses <span class="platform-count" id="details-count">0</span></h3>
        <small>Add custom details like GST No, License No, Registration ID, etc. Items with the same Label will be
          grouped together on your profile.</small>

        <div id="details-container">
          <!-- Detail entries will be added here dynamically -->
        </div>

        <button type="button" class="add-certificate-btn" onclick="addDetailEntry()">
          â• Add Detail / License
        </button>
      </div>

      <!-- Contact Information -->
      <div class="form-section contact">
        <h3>ğŸ“ Contact Information <span class="platform-count">6</span></h3>
        <small>Essential contact details. For multiple emails/phone numbers, separate with commas (e.g.,
          email1@domain.com, email2@domain.com)</small>

        <div class="upi-input-group">
          <input type="text" id="email" placeholder="Email Address(es) - user@example.com, user@gmail.com"
            pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}([,\|\s]+[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})*"
            title="Enter email addresses separated by commas">
          <button type="button" class="add-upi-btn" data-target="email" title="Add another email address">+</button>
        </div>

        <div class="upi-input-group">
          <input type="text" id="phone" placeholder="Phone Number(s) - +1234567890, +1987654321"
            pattern="[\+]?[0-9]+([,\|\s]+[\+]?[0-9]+)*" title="Enter phone numbers separated by commas">
          <button type="button" class="add-upi-btn" data-target="phone" title="Add another phone number">+</button>
        </div>

        <input type="url" id="website" placeholder="Website - https://yourwebsite.com">
        <input type="url" id="businesscard" placeholder="Business Card - https://yourbusinesscard.com">
        <input type="text" id="location" placeholder="Location - City, Country or Google Maps link">
        <input type="url" id="googleReview" placeholder="Google Review Link - https://maps.app.goo.gl/.../review">

        <div id="contact-custom-container" class="custom-links-container"></div>
        <button type="button" class="add-certificate-btn" onclick="addCustomLink('contact', 'ğŸ“ Contact')">
          â• Add Custom Link
        </button>
      </div>

      <div class="form-section"
        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 15px;">
          <label
            style="display: flex; align-items: center; gap: 12px; cursor: pointer; color: white; font-weight: 500; flex: 1;">
            <input type="checkbox" id="includeAllFields"
              style="width: 20px; height: 20px; cursor: pointer; accent-color: #4CAF50;">
            <div>
              <div style="font-size: 15px; margin-bottom: 4px;">ğŸ“‹ Include all fields in JSON output</div>
              <div style="font-size: 12px; opacity: 0.9;">Uncheck to show only fields with values (cleaner output)</div>
            </div>
          </label>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn-primary" id="saveUserBtn" disabled
          style="background-color: #9ca3af; cursor: not-allowed;" title="Checking account status...">â³
          Checking...</button>
        <button type="button" class="btn-secondary" id="backBtn">â† Back to Dashboard</button>
      </div>
    </form>

    <div id="output" class="output-box hidden">
      <h3>âœ… Copy this JSON and add to <span id="targetDataFile">data/clients.json</span>:</h3>
      <textarea id="jsonOutput" readonly placeholder="User JSON data will appear here..."></textarea>
      <button class="btn-primary" id="copyBtn">ğŸ“‹ Copy to Clipboard</button>
    </div>
  </div>

  <script>
    // All supported platforms grouped by category
    const platformGroups = {
      professional: ['linkedin', 'xing', 'angellist', 'meetup', 'opportunity'],
      design: ['behance', 'dribbble', 'figma', 'portfolio', 'artstation', 'zerply'],
      social: ['instagram', 'twitter', 'facebook', 'threads', 'mastodon', 'bluesky'],
      video: ['youtube', 'tiktok', 'vimeo', 'twitch', 'rumble', 'dailymotion'],
      music: ['spotify', 'soundcloud', 'applemusic', 'bandcamp'],
      developer: ['github', 'gitlab', 'bitbucket', 'stackoverflow', 'devto', 'codepen'],
      messaging: ['whatsapp', 'telegram', 'discord', 'signal', 'skype', 'slack', 'wechat', 'line', 'viber', 'messenger'],
      gaming: ['steam', 'xbox', 'playstation', 'nintendo', 'dream11', 'mpl', 'winzo'],
      creator: ['patreon', 'kofi', 'buymeacoffee', 'substack'],
      ecommerce: ['etsy', 'amazon', 'shopify', 'flipkart', 'myntra', 'meesho', 'nykaa', 'bigbasket', 'blinkit', 'zepto'],
      photography: ['flickr', '500px', 'unsplash'],
      blogging: ['medium', 'wordpress', 'blogger'],
      miscSocial: ['pinterest', 'reddit', 'snapchat', 'tumblr', 'bereal', 'clubhouse', 'nextdoor', 'strava', 'sharechat', 'moj', 'josh', 'koo', 'mxtakatak', 'vk', 'ok', 'kakaotalk', 'quora'],
      productivity: ['linktree', 'notion', 'calendly'],
      payment: ['paypal', 'gpay', 'phonepe', 'paytm', 'upi', 'cashapp', 'razorpay', 'cred', 'mobikwik', 'freecharge', 'bhim', 'amazonpay', 'navi', 'jupiter', 'jiofinance'],
      business: ['crunchbase', 'glassdoor', 'indeed', 'naukri'],
      education: ['coursera', 'udemy', 'skillshare', 'khanacademy', 'byjus', 'unacademy', 'vedantu', 'upgrad', 'physicswallah'],
      pricing: ['pricelist'],
      appDownloads: ['playstore', 'appstore'],
      booking: ['bookingpage', 'appointment', 'buytickets', 'reservation', 'registration', 'consultation'],
      food: ['swiggy', 'zomato', 'dineout', 'eatsure', 'magicpin', 'jiomart', 'swiggyinstamart', 'dunzo', 'menucard'],
      transportation: ['ola', 'uber', 'rapido', 'porter'],
      travel: ['makemytrip', 'goibibo', 'oyo', 'cleartrip', 'ixigo'],
      health: ['practo', 'onemg', 'pharmeasy', 'cultfit'],
      ott: ['jiocinema', 'hotstar', 'netflix', 'primevideo', 'sonyliv', 'zee5', 'mxplayer', 'imdb'],
      books: ['goodreads'],
      contact: ['email', 'phone', 'website', 'businesscard', 'location', 'googleReview']
    };

    // Flatten all platforms into one array
    const allPlatforms = Object.values(platformGroups).flat();

    // Generate random code (internal helper)
    function generateRandomCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      const year = new Date().getFullYear();
      let code = '';
      for (let i = 0; i < 8; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return `${year}${code}`;
    }

    // Generate unique user code (checks against existing codes)
    async function generateUniqueUserCode() {
      try {
        let allFiles = [];

        try {
          // Fetch master index to know all files
          const indexRes = await fetch(DATA_FILES_CONFIG.indexFile || './data/index.json');
          if (indexRes.ok) {
            const index = await indexRes.json();
            // Get unique file paths from index values
            allFiles = [...new Set(Object.values(index))];
          } else {
            // Fallback if index fails
            allFiles = DATA_FILES_CONFIG.fallbackFiles || ['personal.json', 'clients.json', 'demo.json'];
          }
        } catch (e) {
          console.error("Error loading index for code generation:", e);
          allFiles = DATA_FILES_CONFIG.fallbackFiles || ['personal.json', 'clients.json', 'demo.json'];
        }

        const allUsers = [];

        // Load users from all files to check for duplicates
        for (const file of allFiles) {
          try {
            const res = await fetch(`./data/${file}`);
            if (res.ok) {
              const users = await res.json();
              allUsers.push(...users);
            }
          } catch (fileErr) {
            console.log(`âš ï¸ Error loading ${file} for code check:`, fileErr.message);
          }
        }

        const existingCodes = allUsers.map(u => u.userCode).filter(c => c);

        // Keep generating until we get a unique code
        let code = generateRandomCode();
        let attempts = 0;
        const maxAttempts = 100; // Prevent infinite loop

        while (existingCodes.includes(code) && attempts < maxAttempts) {
          console.log(`Code ${code} already exists, generating new one...`);
          code = generateRandomCode();
          attempts++;
        }

        if (attempts >= maxAttempts) {
          console.warn('Max attempts reached, using timestamp suffix');
          code = generateRandomCode() + Date.now().toString().slice(-3);
        }

        console.log(`âœ… Generated unique code: ${code}`);
        return code;
      } catch (err) {
        console.error('Error checking existing codes:', err);
        // Fallback: generate with timestamp to ensure uniqueness
        return generateRandomCode() + Date.now().toString().slice(-3);
      }
    }

    // Auto-generate user code on page load (for new users)
    window.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(window.location.search);
      const username = params.get('user');

      // CRITICAL: Check if user is authenticated FIRST
      const adminUsername = sessionStorage.getItem('adminUsername');
      const adminRole = sessionStorage.getItem('adminRole');
      const adminAuthenticated = sessionStorage.getItem('adminAuthenticated');
      const saveBtn = document.getElementById('saveUserBtn');

      // Block unauthenticated access
      if (!adminAuthenticated || !adminUsername || !adminRole) {
        // No authentication - redirect to login
        alert('âš ï¸ Authentication Required\n\nYou must be logged in to create or edit user profiles.\n\nRedirecting to login page...');
        window.location.href = 'admin.html';
        return;
      }

      // Block admin accounts (main_admin and super_admin) from creating/editing profiles
      if (adminRole === 'main_admin' || adminRole === 'super_admin') {
        alert('âš ï¸ Access Denied\n\nAdmin accounts cannot create or edit user profiles.\n\nAdmin accounts are for managing credentials only.\n\nRedirecting to dashboard...');
        window.location.href = 'index.html';
        return;
      }

      // Global flag to track frozen status
      window.isAccountFrozen = false;

      if (adminRole === 'user' && adminUsername) {
        try {
          const { dataService } = await import('./data-service.js');
          const credentials = await dataService.getCredentials();
          const myCred = credentials.find(c => c.username === adminUsername);

          if (myCred && myCred.isFrozen) {
            // Set global frozen flag
            window.isAccountFrozen = true;

            // Keep Save button disabled for frozen accounts
            if (saveBtn) {
              saveBtn.disabled = true;
              saveBtn.style.backgroundColor = '#9ca3af'; // Gray
              saveBtn.style.cursor = 'not-allowed';
              saveBtn.title = "Account is frozen (Read-Only). Cannot save changes.";
              saveBtn.innerHTML = 'â„ï¸ Frozen (Read-Only)';

              // CRITICAL: Use MutationObserver to prevent ANY code from re-enabling the button
              const observer = new MutationObserver(() => {
                if (!saveBtn.disabled || saveBtn.innerHTML !== 'â„ï¸ Frozen (Read-Only)') {
                  saveBtn.disabled = true;
                  saveBtn.style.backgroundColor = '#9ca3af';
                  saveBtn.style.cursor = 'not-allowed';
                  saveBtn.title = "Account is frozen (Read-Only). Cannot save changes.";
                  saveBtn.innerHTML = 'â„ï¸ Frozen (Read-Only)';
                }
              });

              observer.observe(saveBtn, {
                attributes: true,
                attributeFilter: ['disabled'],
                childList: true,
                characterData: true,
                subtree: true
              });

              // Store observer to prevent garbage collection
              window.frozenButtonObserver = observer;
            }

            // Disable all form inputs
            const formInputs = document.querySelectorAll('#userForm input, #userForm textarea, #userForm select');
            formInputs.forEach(input => {
              input.disabled = true;
              input.style.cursor = 'not-allowed';
              input.style.opacity = '0.6';
            });

            // Show frozen notice
            const formTitle = document.getElementById('formTitle');
            if (formTitle && !formTitle.innerHTML.includes('Read-Only')) {
              formTitle.innerHTML += ' <span style="color: #3b82f6; font-size: 0.9em;">â„ï¸ (Read-Only - Account Frozen)</span>';
            }
          } else {
            // Account is NOT frozen - enable Save button
            window.isAccountFrozen = false;
            if (saveBtn) {
              saveBtn.disabled = false;
              saveBtn.style.backgroundColor = '';
              saveBtn.style.cursor = '';
              saveBtn.title = '';
              saveBtn.innerHTML = 'ğŸ’¾ Save User';
            }
          }
        } catch (err) {
          console.error("Frozen check on page load failed:", err);
          // On error, keep button disabled for safety
          window.isAccountFrozen = true;
          if (saveBtn) {
            saveBtn.innerHTML = 'âš ï¸ Error - Contact Admin';
          }
        }
      } else {
        // Main admin or no auth - enable Save button
        window.isAccountFrozen = false;
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.style.backgroundColor = '';
          saveBtn.style.cursor = '';
          saveBtn.title = '';
          saveBtn.innerHTML = 'ğŸ’¾ Save User';
        }
      }

      // Only generate if it's a new user (no username in URL)
      if (!username) {
        const uniqueCode = await generateUniqueUserCode();
        document.getElementById('userCode').value = uniqueCode;
      } else {
        loadUser();
      }
    });

    // Load existing user for editing
    async function loadUser() {
      const params = new URLSearchParams(window.location.search);
      const username = params.get('user');
      const userCode = params.get('code');
      if (!username) return;

      try {
        // 1. Try Loading from Firebase via DataService
        try {
          const { dataService } = await import('./data-service.js');
          // We need scope. Try to guess or find.
          // If we are coming from dashboard, we might know scope.
          // But this page might be opened directly.
          // We can try to find user by searching all scopes (Admin) or just check local index to find scope.

          // Let's use the local Index to find the "scope/file" first, then fetch from Firebase using that scope.
          const indexRes = await fetch(DATA_FILES_CONFIG.indexFile || './data/index.json');
          let scope = null;
          if (indexRes.ok) {
            const index = await indexRes.json();
            // index values are like "personal/personal.json" -> scope "personal"
            if (index[userCode]) {
              const path = index[userCode];
              scope = path.split('/')[0].replace('.json', '');
            } else {
              // Fallback: search values?
            }
          }

          if (scope) {
            // If we found scope, try Firebase
            const fbUser = await dataService.getUser(scope, username); // Try username as ID first
            if (fbUser) {
              console.log("âœ… Loaded from Firebase");
              populateForm(fbUser);
              window.currentUserScope = scope; // Store for update
              window.currentUserDocId = username;
              return;
            }
            // Try userCode as ID
            const fbUserCode = await dataService.getUser(scope, userCode);
            if (fbUserCode) {
              console.log("âœ… Loaded from Firebase (by code)");
              populateForm(fbUserCode);
              window.currentUserScope = scope;
              window.currentUserDocId = userCode;
              return;
            }
          }
          // If not found in index or Firebase by specific scope, try Global Firebase Search
          if (!window.currentUserScope) {
            console.log("ğŸ” Attempting Global Firebase Search...");
            try {
              const allFbUsers = await dataService.getUsers(null); // Fetch all users from all scopes
              const foundFbUser = allFbUsers.find(u =>
                (u.username === username) || (userCode && u.userCode === userCode)
              );

              if (foundFbUser) {
                console.log("âœ… Found user via Global Firebase Search:", foundFbUser);
                populateForm(foundFbUser);

                // Set necessary window variables
                window.currentUserScope = foundFbUser.dataFile; // getUsers injects 'dataFile' (scope)
                window.currentUserDocId = foundFbUser.username; // Default ID
                return;
              }
            } catch (globalErr) {
              console.warn("âš ï¸ Global Firebase Search failed:", globalErr);
            }
          }

        } catch (fbErr) {
          console.warn("âš ï¸ Firebase load failed:", fbErr);
        }

        // 2. Fallback to Local Load (Original Logic)
        let filesToSearch = [];
        const indexUrl = DATA_FILES_CONFIG.indexFile || './data/index.json';

        try {
          const indexRes = await fetch(indexUrl);
          if (indexRes.ok) {
            const index = await indexRes.json();

            // OPTIMIZATION: If we have userCode, look up exact file!
            if (userCode && index[userCode]) {
              console.log(`ğŸ¯ Index lookup: ${userCode} found in ${index[userCode]}`);
              filesToSearch = [index[userCode]];
            } else {
              // Fallback: search all known files if code not in index or not provided
              filesToSearch = [...new Set(Object.values(index))];
            }
          } else {
            throw new Error("Index fetch failed");
          }
        } catch (e) {
          console.warn("Index lookup failed, falling back to default list", e);
          filesToSearch = DATA_FILES_CONFIG.fallbackFiles || ['personal.json', 'clients.json', 'demo.json'];
        }

        let user = null;

        // Search for user across identified data files
        for (const file of filesToSearch) {
          try {
            const res = await fetch(`./data/${file}`);
            if (res.ok) {
              const users = await res.json();

              // Find user by both username AND userCode (handles duplicate usernames)
              if (userCode) {
                // If userCode provided, match both username and code
                user = users.find(u => u.username === username && u.userCode === userCode);
              } else {
                // Fallback: match by username only (for backward compatibility)
                user = users.find(u => u.username === username);
              }

              if (user) {
                console.log(`âœ… Found user in ${file}`);
                // Store found file for display
                window.currentDataFile = `data/${file}`;

                // Determine scope for potential Firebase update later
                let scope = file.split('/')[0].replace('.json', '');
                window.currentUserScope = scope;
                window.currentUserDocId = user.username || user.userCode;

                populateForm(user);
                break; // Stop searching once user is found
              }
            }
          } catch (fileErr) {
            console.log(`âš ï¸ Error searching ${file}:`, fileErr.message);
            // Continue searching other files
          }
        }

      } catch (err) {
        console.error('Error loading user:', err);
      }
    }

    // Restore Back to Dashboard Button
    const backBtn = document.getElementById('backBtn');
    if (backBtn) {
      backBtn.onclick = () => {
        window.location.href = "index.html";
      };
    }

    // Helper to populate form
    // Helper to populate form
    function populateForm(user) {
      document.getElementById('formTitle').innerText = 'âœï¸ Edit User: ' + user.fullname;
      document.getElementById('username').value = user.username || '';
      document.getElementById('username').disabled = true; // Disable username editing

      document.getElementById('fullname').value = user.fullname || '';
      document.getElementById('userCode').value = user.userCode || '';
      document.getElementById('publicDescription').value = user.publicDescription || '';
      document.getElementById('description').value = user.description || '';

      // Populate standard fields
      Object.keys(platformGroups).forEach(group => {
        platformGroups[group].forEach(platform => {
          if (user[platform]) {
            const input = document.getElementById(platform);
            if (input) input.value = user[platform];
          }
        });
      });

      // Load certificates
      if (user.certificates) {
        loadCertificates(user.certificates);
      }

      // Load Google Forms
      if (user.googleForms) {
        loadGoogleForms(user.googleForms);
      }

      // Load custom links
      const categories = [
        'professional', 'design', 'social', 'video', 'music', 'developer',
        'messaging', 'gaming', 'creator', 'ecommerce', 'photography', 'blogging',
        'miscSocial', 'productivity', 'payment', 'business', 'education', 'pricing', 'appDownloads',
        'booking', 'food', 'transportation', 'travel', 'health', 'ott', 'books', 'contact'
      ];

      categories.forEach(category => {
        const customKey = `${category}Custom`;
        if (user[customKey]) {
          loadCustomLinks(category, user[customKey]);
        }
      });

      // Load Details & Licenses
      if (user.customDetails) {
        loadDetails(user.customDetails);
      }
    }

    // Handle Form Submit (Create / Update / Generate JSON)
    document.getElementById('userForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      // --- AUTHENTICATION CHECK (Primary) ---
      const adminAuthenticated = sessionStorage.getItem('adminAuthenticated');
      const adminUsername = sessionStorage.getItem('adminUsername');
      const adminRole = sessionStorage.getItem('adminRole');

      // Block unauthenticated submissions
      if (!adminAuthenticated || !adminUsername || !adminRole) {
        alert('âš ï¸ Authentication Required\n\nYou must be logged in to save user profiles.\n\nRedirecting to login page...');
        window.location.href = 'admin.html';
        return;
      }

      // Block admin accounts (main_admin and super_admin) from creating/editing profiles
      if (adminRole === 'main_admin' || adminRole === 'super_admin') {
        alert('âš ï¸ Access Denied\n\nAdmin accounts cannot create or edit user profiles.\n\nAdmin accounts are for managing credentials only.\n\nRedirecting to dashboard...');
        window.location.href = 'index.html';
        return;
      }

      // --- FROZEN ACCOUNT CHECK (Backup - button should already be disabled) ---
      const params = new URLSearchParams(window.location.search);
      const isEditing = params.has('user');

      // Backup check: If somehow the frozen account bypassed the disabled button
      if (adminRole === 'user' && adminUsername) {
        try {
          const { dataService } = await import('./data-service.js');
          const credentials = await dataService.getCredentials();
          const myCred = credentials.find(c => c.username === adminUsername);

          if (myCred && myCred.isFrozen) {
            // Silent block - no alert needed since button should be disabled
            window.location.href = "index.html";
            return;
          }
        } catch (err) {
          console.error("Frozen check failed:", err);
        }
      }

      // --- LIMIT CHECK FOR NEW USERS ---
      // Only check limit if:
      // 1. We are CREATING a new user (not editing)
      // 2. The logged-in person is a 'user' (Client User), not a Main Admin
      if (!isEditing && adminRole === 'user' && adminUsername) {
        try {
          const { dataService } = await import('./data-service.js');

          // 1. Get My Account Rules (Limit)
          // We need to find the credential doc for the logged-in admin
          // Since we don't have a direct 'getCredential' by ID, we fetch all (optimized if possible, but fine for now)
          // Or utilize the fact that we might have stored it? No, safer to fetch fresh.
          const credentials = await dataService.getCredentials();
          const myCred = credentials.find(c => c.username === adminUsername);

          if (myCred && myCred.isUnlimited === false) {
            const maxUsers = myCred.maxUsers || 100;

            // 2. Count My Current Profiles
            // My profiles are in the file defined in myCred.dataFile (e.g., 'clients')
            // Or we can rely on sessionStorage 'adminDataFile'
            const dataFile = sessionStorage.getItem('adminDataFile') || myCred.dataFile || 'clients';
            const scope = dataFile.replace('.json', '').replace('data/', '');

            // Fetch users in my scope
            const myUsers = await dataService.getUsers(scope);

            // Filter? dataService.getUsers returns ALL in that scope.
            // If I share the scope with others? (Usually 1 file per client or shared 'clients.json'?)
            // If shared 'clients.json', do I own ALL of them?
            // Main Admin sees them all.
            // Client User sees... what?
            // Client User usually sees ALL users in their assigned dataFile. 
            // So if dataFile is unique to them, count is length.
            // If dataFile is shared, we might need to filter by 'owner'? (Not implemented yet).
            // Assuming 1 DataFile = 1 Client User's Sandbox for now based on 'Total Users' logic in script.js

            const currentCount = myUsers ? myUsers.length : 0;

            if (currentCount >= maxUsers) {
              alert(`âš ï¸ User Limit Reached (${currentCount}/${maxUsers}).\n\nYou cannot create more profiles. Please contact admin.`);

              // Redirect back to dashboard
              window.location.href = "index.html";
              return;
            }
          }
        } catch (err) {
          console.error("Limit check failed:", err);
          // Fallback: allow or block? Block to be safe? Or allow if error?
          // Allow for now to avoid locking out due to network error, but log it.
        }
      }
      // --- END LIMIT CHECK ---

      const usernameInput = document.getElementById('username').value;
      const normalizedUsername = usernameInput.trim().replace(/\s+/g, '-');

      const data = {
        username: normalizedUsername,
        fullname: document.getElementById('fullname').value.trim(),
        publicDescription: document.getElementById('publicDescription').value.trim(),
        userCode: document.getElementById('userCode').value.trim(),
        description: document.getElementById('description').value.trim()
      };

      // Add comment headers for consistency and organization
      data._comment_professional = "=== PROFESSIONAL & BUSINESS NETWORKS ===";
      platformGroups.professional.forEach(p => data[p] = document.getElementById(p)?.value.trim() || "");

      data._comment_design = "=== CREATIVE & DESIGN PORTFOLIOS ===";
      platformGroups.design.forEach(p => data[p] = document.getElementById(p)?.value.trim() || "");

      data._comment_social = "=== SOCIAL MEDIA PLATFORMS ===";
      platformGroups.social.forEach(p => data[p] = document.getElementById(p)?.value.trim() || "");

      data._comment_video = "=== VIDEO PLATFORMS ===";
      platformGroups.video.forEach(p => data[p] = document.getElementById(p)?.value.trim() || "");

      data._comment_music = "=== MUSIC & AUDIO PLATFORMS ===";
      platformGroups.music.forEach(p => data[p] = document.getElementById(p)?.value.trim() || "");

      data._comment_developer = "=== DEVELOPER & TECH COMMUNITIES ===";
      platformGroups.developer.forEach(p => data[p] = document.getElementById(p)?.value.trim() || "");

      data._comment_messaging = "=== MESSAGING & COMMUNICATION ===";
      platformGroups.messaging.forEach(p => data[p] = document.getElementById(p)?.value.trim() || "");

      data._comment_gaming = "=== GAMING PLATFORMS ===";
      platformGroups.gaming.forEach(p => data[p] = document.getElementById(p)?.value.trim() || "");

      data._comment_creator = "=== CREATOR & MONETIZATION ===";
      platformGroups.creator.forEach(p => data[p] = document.getElementById(p)?.value.trim() || "");

      data._comment_ecommerce = "=== E-COMMERCE & SHOPPING ===";
      platformGroups.ecommerce.forEach(p => data[p] = document.getElementById(p)?.value.trim() || "");

      data._comment_photography = "=== PHOTOGRAPHY & VISUAL ARTS ===";
      platformGroups.photography.forEach(p => data[p] = document.getElementById(p)?.value.trim() || "");

      data._comment_blogging = "=== BLOGGING & WRITING ===";
      platformGroups.blogging.forEach(p => data[p] = document.getElementById(p)?.value.trim() || "");

      data._comment_misc_social = "=== OTHER SOCIAL PLATFORMS ===";
      platformGroups.miscSocial.forEach(p => data[p] = document.getElementById(p)?.value.trim() || "");

      data._comment_productivity = "=== PRODUCTIVITY & TOOLS ===";
      platformGroups.productivity.forEach(p => data[p] = document.getElementById(p)?.value.trim() || "");

      data._comment_payment = "=== PAYMENT & DONATION PLATFORMS ===";
      platformGroups.payment.forEach(p => data[p] = document.getElementById(p)?.value.trim() || "");

      data._comment_business = "=== BUSINESS & PROFESSIONAL TOOLS ===";
      platformGroups.business.forEach(p => data[p] = document.getElementById(p)?.value.trim() || "");

      data._comment_education = "=== EDUCATION & LEARNING ===";
      platformGroups.education.forEach(p => data[p] = document.getElementById(p)?.value.trim() || "");

      data._comment_pricing = "=== BUSINESS SERVICES & PRICING ===";
      platformGroups.pricing.forEach(p => data[p] = document.getElementById(p)?.value.trim() || "");

      data._comment_appDownloads = "=== APP DOWNLOADS ===";
      platformGroups.appDownloads.forEach(p => data[p] = document.getElementById(p)?.value.trim() || "");

      data._comment_booking = "=== BOOKING & ACTIONS ===";
      platformGroups.booking.forEach(p => data[p] = document.getElementById(p)?.value.trim() || "");

      data._comment_food = "=== FOOD & DINING ===";
      platformGroups.food.forEach(p => data[p] = document.getElementById(p)?.value.trim() || "");

      data._comment_transportation = "=== RIDE & TRANSPORTATION ===";
      platformGroups.transportation.forEach(p => data[p] = document.getElementById(p)?.value.trim() || "");

      data._comment_travel = "=== TRAVEL & HOSPITALITY ===";
      platformGroups.travel.forEach(p => data[p] = document.getElementById(p)?.value.trim() || "");

      data._comment_health = "=== HEALTH & WELLNESS ===";
      platformGroups.health.forEach(p => data[p] = document.getElementById(p)?.value.trim() || "");

      data._comment_ott = "=== ENTERTAINMENT & OTT ===";
      platformGroups.ott.forEach(p => data[p] = document.getElementById(p)?.value.trim() || "");

      data._comment_books = "=== BOOKS & READING ===";
      platformGroups.books.forEach(p => data[p] = document.getElementById(p)?.value.trim() || "");

      // Collect certificates
      const certificates = [];
      const certificatesContainer = document.getElementById('certificates-container');
      if (certificatesContainer) {
        certificatesContainer.querySelectorAll('.certificate-entry').forEach(entry => {
          const titleInput = entry.querySelector('.cert-title');
          const urlInput = entry.querySelector('.cert-url');

          if (titleInput && urlInput && titleInput.value.trim() && urlInput.value.trim()) {
            certificates.push({
              title: titleInput.value.trim(),
              url: urlInput.value.trim()
            });
          }
        });
      }

      // Collect Google Forms
      const googleForms = [];
      const googleFormsContainer = document.getElementById('googleforms-container');
      if (googleFormsContainer) {
        googleFormsContainer.querySelectorAll('.googleform-entry').forEach(entry => {
          const titleInput = entry.querySelector('.googleform-title');
          const urlInput = entry.querySelector('.googleform-url');

          if (titleInput && urlInput && titleInput.value.trim() && urlInput.value.trim()) {
            googleForms.push({
              title: titleInput.value.trim(),
              url: urlInput.value.trim()
            });
          }
        });
      }

      // Collect custom links
      const categories = [
        'professional', 'design', 'social', 'video', 'music', 'developer',
        'messaging', 'gaming', 'creator', 'ecommerce', 'photography', 'blogging',
        'miscSocial', 'productivity', 'payment', 'business', 'education', 'pricing', 'appDownloads',
        'booking', 'food', 'transportation', 'travel', 'health', 'ott', 'books', 'contact'
      ];

      categories.forEach(category => {
        const customLinks = [];
        const titleInputs = document.querySelectorAll(`.custom-link-title[data-category="${category}"]`);
        const urlInputs = document.querySelectorAll(`.custom-link-url[data-category="${category}"]`);

        titleInputs.forEach((titleInput, index) => {
          const urlInput = urlInputs[index];

          if (titleInput && urlInput && titleInput.value.trim() && urlInput.value.trim()) {
            customLinks.push({
              title: titleInput.value.trim(),
              url: urlInput.value.trim()
            });
          }
        });

        if (customLinks.length > 0) {
          data[`${category}Custom`] = customLinks;
        } else {
          data[`${category}Custom`] = []; // Explicitly set empty array if no links
        }
      });

      // Add Arrays to Data
      data._comment_certificates = "=== CERTIFICATES & CREDENTIALS ===";
      data.certificates = certificates.length > 0 ? certificates : [];

      data._comment_googleforms = "=== GOOGLE FORMS ===";
      data.googleForms = googleForms.length > 0 ? googleForms : [];

      data._comment_contact = "=== CONTACT INFORMATION ===";
      platformGroups.contact.forEach(p => data[p] = document.getElementById(p)?.value.trim() || "");

      // Collect Details & Licenses
      const customDetails = [];
      const detailsContainer = document.getElementById('details-container');
      if (detailsContainer) {
        detailsContainer.querySelectorAll('.detail-entry').forEach(entry => {
          const labelInput = entry.querySelector('.detail-label');
          const valueInput = entry.querySelector('.detail-value');

          if (labelInput && valueInput && labelInput.value.trim() && valueInput.value.trim()) {
            customDetails.push({
              label: labelInput.value.trim(),
              value: valueInput.value.trim()
            });
          }
        });
      }

      data._comment_details = "=== DETAILS & LICENSES ===";
      data.customDetails = customDetails.length > 0 ? customDetails : [];

      // 4. CLEAN DATA (Optional, based on checkbox)
      const includeAllFields = document.getElementById('includeAllFields').checked;
      let finalData = data;

      if (!includeAllFields) {
        finalData = {};
        // Always keep core identity fields
        ['username', 'fullname', 'userCode'].forEach(k => finalData[k] = data[k]);

        // Copy others only if meaningful
        Object.keys(data).forEach(key => {
          if (key.startsWith('_comment_')) return; // Skip comments
          if (['username', 'fullname', 'userCode'].includes(key)) return;

          const val = data[key];

          // CRITICAL FIX: Explicitly Include Empty Arrays for dynamic lists to ensure they are CLEARED in Firebase
          // (Firebase 'merge: true' would otherwise keep the old data if we omit the key)
          if (key === 'certificates' || key === 'googleForms' || key === 'customDetails' || key.endsWith('Custom')) {
            if (Array.isArray(val)) {
              finalData[key] = val; // Include even if empty []
            }
          } else {
            // For other fields, keep the "clean" logic (omit if empty)
            if (Array.isArray(val) && val.length > 0) finalData[key] = val;
            else if (typeof val === 'string' && val.trim() !== '') finalData[key] = val;
          }
        });
      }

      // 5. SAVE TO FIREBASE OR SHOW JSON
      const saveBtn = document.querySelector('button[type="submit"]');
      const originalBtnText = saveBtn.innerHTML;
      saveBtn.disabled = true;
      saveBtn.innerHTML = 'â³ Saving...';

      try {
        const { dataService } = await import('./data-service.js');

        let scope = window.currentUserScope;
        let docId = window.currentUserDocId;

        // If no scope (New User), try to determine from session
        if (!scope) {
          const sessionFile = sessionStorage.getItem('adminDataFile');
          if (sessionFile) {
            // e.g. "data/clients.json" or just "clients"
            scope = sessionFile.replace('data/', '').replace('.json', '');
          } else {
            // Fallback default
            scope = 'clients';
          }
          docId = finalData.username; // New user uses username as ID
        }

        await dataService.updateUser(scope, docId || finalData.username, finalData);

        saveBtn.innerHTML = 'âœ… Saved!';
        saveBtn.style.backgroundColor = '#4CAF50'; // Success Green

        setTimeout(() => {
          saveBtn.innerHTML = originalBtnText;
          saveBtn.style.backgroundColor = ''; // Revert color
          saveBtn.disabled = false;
        }, 2000);

      } catch (e) {
        console.error("Save failed:", e);
        saveBtn.innerHTML = 'âŒ Save Failed';
        saveBtn.style.backgroundColor = '#f44336'; // Error Red

        setTimeout(() => {
          saveBtn.innerHTML = originalBtnText;
          saveBtn.style.backgroundColor = '';
          saveBtn.disabled = false;
        }, 3000);

        // Show JSON backup automatically on error
        document.getElementById('output').style.display = 'block';
        document.getElementById('output').scrollIntoView({ behavior: 'smooth' });
      }

      // Show JSON Output (Backup)
      const jsonOutput = JSON.stringify(finalData, null, 2)
        .replace(/,\n  "_comment_/g, ',\n\n  "_comment_')
        .replace(/,\n  "username"/g, ',\n\n  "username"')
        .replace(/,\n  "fullname"/g, ',\n  "fullname"')
        .replace(/,\n  "userCode"/g, ',\n  "userCode"')
        .replace(/,\n  "(\w+Custom)":/g, ',\n\n  "$1":');

      document.getElementById('jsonOutput').value = jsonOutput;

      let targetInfo = window.currentDataFile || sessionStorage.getItem('adminDataFile') || 'data/clients.json';
      document.getElementById('targetDataFile').innerText = targetInfo;

      document.getElementById('output').style.display = 'block';
      document.getElementById('output').scrollIntoView({ behavior: 'smooth' });
    });

    document.getElementById('copyBtn').onclick = () => {
      const textarea = document.getElementById('jsonOutput');
      textarea.select();
      document.execCommand('copy');

      const btn = document.getElementById('copyBtn');
      const originalText = btn.innerHTML;
      btn.innerHTML = 'âœ… Copied!';
      setTimeout(() => {
        btn.innerHTML = originalText;
      }, 2000);
    };

    // Input sanitization function
    function sanitizeInput(input) {
      if (typeof input !== 'string') return '';
      return input.replace(/[<>\"'&]/g, function (match) {
        const escapeMap = {
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#x27;',
          '&': '&amp;'
        };
        return escapeMap[match];
      });
    }

    // Check if user is authenticated and show admin links
    function checkAdminStatus() {
      const isAuthenticated = sessionStorage.getItem('adminAuthenticated');
      const loginTime = sessionStorage.getItem('adminLoginTime');
      const dataFile = sessionStorage.getItem('adminDataFile');

      if (isAuthenticated && loginTime) {
        const sessionAge = Date.now() - parseInt(loginTime);
        const maxSessionAge = 24 * 60 * 60 * 1000; // 24 hours

        if (sessionAge <= maxSessionAge) {
          // Show admin links
          document.getElementById('adminLinks').style.display = 'block';

          // Update target data file display if user has a specific dataFile
          if (dataFile) {
            const fullPath = dataFile.startsWith('data/') ? dataFile : `data/${dataFile}`;
            document.getElementById('targetDataFile').innerText = fullPath;
          }
        }
      }
    }

    // Load user data (no authentication required for this page)
    loadUser();

    // Check admin status
    checkAdminStatus();

    // Handle multiple UPI IDs functionality
    function setupUPIInputGroups() {
      document.querySelectorAll('.add-upi-btn').forEach(btn => {
        btn.addEventListener('click', function () {
          const targetId = this.dataset.target;
          const input = document.getElementById(targetId);
          const currentValue = input.value.trim();

          if (currentValue) {
            // If there's already content, add a comma and focus
            if (!currentValue.endsWith(',')) {
              input.value = currentValue + ', ';
            }
          } else {
            // If empty, add placeholder text
            input.placeholder = input.placeholder.replace('UPI ID(s)', 'UPI ID');
          }

          input.focus();
          input.setSelectionRange(input.value.length, input.value.length);
        });
      });
    }

    // Initialize UPI input groups when DOM is loaded
    document.addEventListener('DOMContentLoaded', setupUPIInputGroups);

    // Certificate Management Functions
    let certificateCounter = 0;

    function addCertificateEntry() {
      certificateCounter++;
      const container = document.getElementById('certificates-container');

      const certEntry = document.createElement('div');
      certEntry.className = 'certificate-entry';
      certEntry.id = `cert-entry-${certificateCounter}`;
      certEntry.innerHTML = `
        <div class="cert-inputs">
          <input type="text" 
                 class="cert-title" 
                 id="cert-title-${certificateCounter}" 
                 placeholder="Certificate Title (e.g., AWS Certified Solutions Architect)"
                 required>
          <input type="url" 
                 class="cert-url" 
                 id="cert-url-${certificateCounter}" 
                 placeholder="Certificate URL (e.g., https://example.com/certificate.pdf)"
                 required>
          <button type="button" 
                  class="remove-cert-btn" 
                  onclick="removeCertificateEntry(${certificateCounter})"
                  title="Remove this certificate">
            âœ–
          </button>
        </div>
      `;

      container.appendChild(certEntry);
      updateCertificateCount();

      // Focus on the title input
      document.getElementById(`cert-title-${certificateCounter}`).focus();
    }

    function removeCertificateEntry(id) {
      const entry = document.getElementById(`cert-entry-${id}`);
      if (entry) {
        entry.remove();
        updateCertificateCount();
      }
    }

    function updateCertificateCount() {
      const count = document.querySelectorAll('.certificate-entry').length;
      document.getElementById('cert-count').textContent = count;
    }

    // Load existing certificates when editing
    function loadCertificates(certificates) {
      if (!certificates || !Array.isArray(certificates)) return;

      const container = document.getElementById('certificates-container');
      container.innerHTML = '';
      certificateCounter = 0;

      certificates.forEach(cert => {
        addCertificateEntry();
        const lastId = certificateCounter;
        document.getElementById(`cert-title-${lastId}`).value = cert.title || '';
        document.getElementById(`cert-url-${lastId}`).value = cert.url || '';
      });
      updateCertificateCount();
    }

    // Google Forms Management Functions
    let googleFormCounter = 0;

    function addGoogleFormEntry() {
      googleFormCounter++;
      const container = document.getElementById('googleforms-container');

      const formEntry = document.createElement('div');
      formEntry.className = 'googleform-entry certificate-entry';
      formEntry.id = `googleform-entry-${googleFormCounter}`;
      formEntry.innerHTML = `
        <div class="cert-inputs">
          <input type="text" 
                 class="googleform-title cert-title" 
                 id="googleform-title-${googleFormCounter}" 
                 placeholder="Form Title (e.g., Customer Feedback Survey)"
                 required>
          <input type="url" 
                 class="googleform-url cert-url" 
                 id="googleform-url-${googleFormCounter}" 
                 placeholder="Google Form URL (e.g., https://forms.gle/abc123)"
                 required>
          <button type="button" 
                  class="remove-cert-btn" 
                  onclick="removeGoogleFormEntry(${googleFormCounter})"
                  title="Remove this form">
            âœ–
          </button>
        </div>
      `;

      container.appendChild(formEntry);
      updateGoogleFormCount();

      // Focus on the title input
      document.getElementById(`googleform-title-${googleFormCounter}`).focus();
    }

    function removeGoogleFormEntry(id) {
      const entry = document.getElementById(`googleform-entry-${id}`);
      if (entry) {
        entry.remove();
        updateGoogleFormCount();
      }
    }

    function updateGoogleFormCount() {
      const count = document.querySelectorAll('.googleform-entry').length;
      document.getElementById('googleforms-count').textContent = count;
    }

    // Load existing Google Forms when editing
    function loadGoogleForms(googleForms) {
      if (!googleForms || !Array.isArray(googleForms)) return;

      const container = document.getElementById('googleforms-container');
      container.innerHTML = '';
      googleFormCounter = 0;

      googleForms.forEach(form => {
        addGoogleFormEntry();
        const lastId = googleFormCounter;
        document.getElementById(`googleform-title-${lastId}`).value = form.title || '';
        document.getElementById(`googleform-url-${lastId}`).value = form.url || '';
      });
      updateGoogleFormCount();
    }

    // Custom Links Management Functions
    let customLinkCounters = {};

    function addCustomLink(category, categoryLabel) {
      if (!customLinkCounters[category]) {
        customLinkCounters[category] = 0;
      }
      customLinkCounters[category]++;

      const container = document.getElementById(`${category}-custom-container`);
      const id = `${category}-${customLinkCounters[category]}`;

      const entry = document.createElement('div');
      entry.className = 'certificate-entry';
      entry.id = `custom-entry-${id}`;
      entry.innerHTML = `
        <div class="cert-inputs">
          <input type="text" 
                 class="cert-title custom-link-title" 
                 data-category="${category}"
                 placeholder="Platform Name (e.g., MyCustomPlatform)"
                 required>
          <input type="url" 
                 class="cert-url custom-link-url" 
                 data-category="${category}"
                 placeholder="URL (e.g., https://example.com/profile)"
                 required>
          <button type="button" 
                  class="remove-cert-btn" 
                  onclick="removeCustomLink('${id}')"
                  title="Remove this link">
            âœ–
          </button>
        </div>
      `;

      container.appendChild(entry);

      // Focus on the title input
      entry.querySelector('.custom-link-title').focus();
    }

    function removeCustomLink(id) {
      const entry = document.getElementById(`custom-entry-${id}`);
      if (entry) {
        entry.remove();
      }
    }

    // Load existing custom links when editing
    function loadCustomLinks(category, customLinks) {
      if (!customLinks || !Array.isArray(customLinks) || customLinks.length === 0) return;

      const container = document.getElementById(`${category}-custom-container`);
      container.innerHTML = '';
      if (customLinkCounters[category]) customLinkCounters[category] = 0;

      customLinks.forEach(link => {
        addCustomLink(category, '');
        const container = document.getElementById(`${category}-custom-container`);
        const entries = container.querySelectorAll('.certificate-entry');
        const lastEntry = entries[entries.length - 1];

        if (lastEntry) {
          lastEntry.querySelector('.custom-link-title').value = link.title || '';
          lastEntry.querySelector('.custom-link-url').value = link.url || '';
        }
      });
    }

    // Details & Licenses Management Functions
    let detailCounter = 0;

    function addDetailEntry() {
      detailCounter++;
      const container = document.getElementById('details-container');

      const detailEntry = document.createElement('div');
      detailEntry.className = 'detail-entry certificate-entry'; // Reuse certificate styling
      detailEntry.id = `detail-entry-${detailCounter}`;
      detailEntry.innerHTML = `
        <div class="cert-inputs">
          <input type="text" 
                 class="detail-label cert-title" 
                 id="detail-label-${detailCounter}" 
                 placeholder="Label (e.g., GST No, FSSAI, License No)"
                 list="detail-label-suggestions"
                 required>
          <input type="text" 
                 class="detail-value cert-url" 
                 id="detail-value-${detailCounter}" 
                 placeholder="Value (e.g., 22AAAAA0000A1Z5)"
                 required>
          <button type="button" 
                  class="remove-cert-btn" 
                  onclick="removeDetailEntry(${detailCounter})"
                  title="Remove this detail">
            âœ–
          </button>
        </div>
      `;

      container.appendChild(detailEntry);
      updateDetailCount();

      // Focus on the label input
      document.getElementById(`detail-label-${detailCounter}`).focus();
    }

    function removeDetailEntry(id) {
      const entry = document.getElementById(`detail-entry-${id}`);
      if (entry) {
        entry.remove();
        updateDetailCount();
      }
    }

    function updateDetailCount() {
      const count = document.querySelectorAll('.detail-entry').length;
      document.getElementById('details-count').textContent = count;
    }

    // Load existing details when editing
    function loadDetails(details) {
      if (!details || !Array.isArray(details)) return;

      const container = document.getElementById('details-container');
      container.innerHTML = '';
      detailCounter = 0;

      details.forEach(detail => {
        addDetailEntry();
        const lastId = detailCounter;
        document.getElementById(`detail-label-${lastId}`).value = detail.label || '';
        document.getElementById(`detail-value-${lastId}`).value = detail.value || '';
      });
      updateDetailCount();
    }

  </script>
</body>

</html>